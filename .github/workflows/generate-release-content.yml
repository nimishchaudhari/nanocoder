name: Generate Release Content

on:
  # Manual trigger from Actions UI
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to generate content for (e.g., 1.19.0)'
        required: true
        type: string

  # Called by other workflows
  workflow_call:
    inputs:
      version:
        description: 'Version to generate content for'
        required: true
        type: string
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN:
        required: true

permissions:
  contents: write
  id-token: write

jobs:
  generate-content:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate release content with Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: "--max-turns 10 --allowedTools Bash Write Read Glob"
          prompt: |
            Read the CHANGELOG.md file and extract the entry for version ${{ inputs.version }}.

            Create a directory called `release-content/` and generate THREE markdown files inside it:

            1. `release-content/blog-post.md` - A full blog post (300-500 words) announcing the release.
               - Professional but approachable tone
               - Highlight the key features and improvements
               - Include code examples if relevant
               - End with a call to action to try the new version

            2. `release-content/x-post.md` - A short X/Twitter post (under 280 characters).
               - Punchy and engaging
               - Include the key highlight
               - Use placeholder {{RELEASE_URL}} for the release link

            3. `release-content/reddit-post.md` - A medium-length Reddit post (150-250 words).
               - Conversational tone suitable for r/programming or r/commandline
               - Explain what's new and why it matters
               - Include the version number in the title

      - name: Upload release content
        uses: actions/upload-artifact@v4
        with:
          name: release-content-v${{ inputs.version }}
          path: release-content/
          retention-days: 90
